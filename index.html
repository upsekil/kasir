<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>F2POS - Aplikasi Konter HP</title>
    
    <!-- LIBRARIES (CDN) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* Print Styles */
        @media print {
            @page { margin: 0; size: auto; }
            aside, main, .no-print, header, .fixed, .login-screen { display: none !important; }
            body, #app { background: white !important; height: auto !important; width: 100% !important; display: block !important; position: static !important; }
            #receipt-area { display: block !important; position: absolute; left: 0; top: 0; width: 100%; visibility: visible !important; }
        }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex bg-slate-100">

<div id="app" class="w-full h-full flex relative">

    <!-- 0. HALAMAN LOGIN -->
    <transition name="fade">
        <div v-if="!isLoggedIn" class="fixed inset-0 z-[100] bg-slate-900 flex flex-col items-center justify-center p-4 login-screen">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-8 text-center animate-fade-in">
                <!-- Logo Login -->
                <div class="w-20 h-20 bg-indigo-600 rounded-2xl mx-auto mb-6 flex items-center justify-center shadow-lg shadow-indigo-500/30">
                    <img v-if="settings.storeLogo" :src="settings.storeLogo" class="w-full h-full object-contain p-1 rounded-2xl bg-white">
                    <i v-else class="fas fa-mobile-alt text-4xl text-white"></i>
                </div>
                
                <h2 class="text-2xl font-bold text-slate-800 mb-1">{{ settings.storeName || 'F2POS' }}</h2>
                <p class="text-slate-500 text-sm mb-6">Masukkan PIN untuk akses kasir</p>
                
                <form @submit.prevent="handleLogin">
                    <div class="mb-6 relative">
                        <input 
                            v-model="loginPin" 
                            type="password" 
                            inputmode="numeric" 
                            class="w-full text-center text-3xl font-bold tracking-[0.5em] p-3 border-b-2 border-slate-200 focus:border-indigo-600 focus:outline-none transition-colors"
                            placeholder="••••••"
                            maxlength="6"
                            ref="pinInputRef"
                        >
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all">
                        MASUK APLIKASI
                    </button>
                </form>

                <div class="mt-8 pt-6 border-t border-slate-100">
                    <p class="text-[10px] text-slate-400 font-medium">Developed by <span class="text-indigo-600">upsekil.com</span></p>
                    <p class="text-[10px] text-slate-400">Made with AI Gemini</p>
                </div>
            </div>
        </div>
    </transition>
    
    <!-- WRAPPER UTAMA (Hanya muncul jika login) -->
    <div v-if="isLoggedIn" class="flex w-full h-full">
        <!-- MOBILE BACKDROP -->
        <div v-if="mobileMenuOpen" @click="mobileMenuOpen = false" class="fixed inset-0 bg-black/50 z-30 md:hidden transition-opacity"></div>
        
        <!-- SIDEBAR -->
        <aside :class="[
            'bg-slate-900 text-white flex flex-col transition-transform duration-300 shadow-xl z-40 no-print', 
            'fixed inset-y-0 left-0 md:relative',
            mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0',
            sidebarCollapsed ? 'md:w-20' : 'w-64'
        ]">
            <div class="h-16 flex items-center justify-center border-b border-slate-700 px-2 gap-3 relative">
                <div :class="['w-10 h-10 rounded-lg flex items-center justify-center shadow-lg shrink-0 overflow-hidden', settings.storeLogo ? 'bg-white' : 'bg-indigo-600 shadow-indigo-500/30']">
                    <img v-if="settings.storeLogo" :src="settings.storeLogo" class="w-full h-full object-contain p-0.5">
                    <i v-else class="fas fa-mobile-alt text-xl text-white"></i>
                </div>
                <span v-if="!sidebarCollapsed" class="font-bold text-lg tracking-tight whitespace-nowrap truncate">
                    {{ settings.storeName || 'F2POS' }}
                </span>
                <button @click="mobileMenuOpen = false" class="absolute right-2 top-4 md:hidden text-slate-400"><i class="fas fa-times"></i></button>
            </div>

            <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-2">
                <template v-for="item in menuItems" :key="item.id">
                    <button 
                        @click="activeTab = item.id; mobileMenuOpen = false"
                        :class="['w-full flex items-center p-3 rounded-xl transition-all duration-200 group relative', 
                            activeTab === item.id 
                            ? 'bg-indigo-600 text-white shadow-lg' 
                            : 'text-slate-400 hover:bg-slate-800 hover:text-white']"
                    >
                        <i :class="['fas text-lg w-6 text-center', item.icon]"></i>
                        <span v-if="!sidebarCollapsed" class="ml-3 font-medium text-sm whitespace-nowrap">{{ item.label }}</span>
                        <div v-if="sidebarCollapsed" class="hidden md:block absolute left-14 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 pointer-events-none">
                            {{ item.label }}
                        </div>
                    </button>
                </template>
            </nav>

            <!-- Developer Credit in Sidebar -->
            <div v-if="!sidebarCollapsed" class="p-4 text-center border-t border-slate-800">
                <div class="text-[10px] text-slate-500">Developed by <a href="https://upsekil.com" target="_blank" class="text-slate-400 hover:text-white">upsekil.com</a></div>
                <div class="text-[10px] text-slate-600">Made with AI Gemini</div>
            </div>

            <button @click="handleLogout" class="p-4 bg-red-600 hover:bg-red-700 text-white flex justify-center items-center gap-2 transition-colors">
                <i class="fas fa-sign-out-alt"></i>
                <span v-if="!sidebarCollapsed" class="text-sm font-bold">Keluar</span>
            </button>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col h-full overflow-hidden bg-slate-100 relative no-print w-full">
            <!-- HEADER -->
            <header class="h-16 bg-white border-b border-slate-200 flex justify-between items-center px-4 md:px-6 shadow-sm z-10 shrink-0">
                <div class="flex items-center gap-3">
                    <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden text-slate-600 hover:text-indigo-600 text-xl p-1"><i class="fas fa-bars"></i></button>
                    <h2 class="text-lg md:text-xl font-bold text-slate-800 truncate">{{ pageTitle }}</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <div class="text-xs text-slate-500">{{ currentDate }}</div>
                        <div class="text-sm font-bold text-indigo-600">{{ currentTime }}</div>
                    </div>
                    <div class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold border border-blue-200 flex items-center gap-1">
                        <div class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div> <span class="hidden sm:inline">Online</span>
                    </div>
                </div>
            </header>

            <!-- CONTENT VIEWS -->
            <div class="flex-1 overflow-hidden relative p-3 md:p-6">
                
                <!-- 1. DASHBOARD -->
                <transition name="fade">
                    <div v-if="activeTab === 'dashboard'" class="h-full overflow-y-auto custom-scroll pb-20 md:pb-0">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-6">
                            <div v-for="(stat, idx) in dashboardStats" :key="idx" class="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between">
                                <div><p class="text-slate-500 text-xs font-bold uppercase mb-1">{{ stat.title }}</p><h3 class="text-xl md:text-2xl font-bold text-slate-800">{{ stat.value }}</h3></div>
                                <div :class="['w-10 h-10 md:w-12 md:h-12 rounded-lg flex items-center justify-center text-lg md:text-xl shadow-sm', stat.bg, stat.color]"><i :class="['fas', stat.icon]"></i></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="font-bold text-lg mb-4 text-slate-800">Tren Penjualan</h3><div class="h-56 md:h-64 relative"><canvas id="salesChart"></canvas></div>
                            </div>
                            <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="font-bold text-lg mb-4 text-slate-800">Stok Menipis</h3>
                                <div class="space-y-3 overflow-y-auto max-h-64 custom-scroll">
                                    <div v-if="lowStockProducts.length === 0" class="text-center text-slate-400 py-4 text-sm">Aman, stok mencukupi.</div>
                                    <div v-for="item in lowStockProducts" :key="item.id" class="flex items-center gap-3 p-2 bg-red-50 rounded-lg border border-red-100">
                                        <div class="w-8 h-8 rounded bg-white flex items-center justify-center text-red-500 font-bold text-xs shadow-sm">!</div>
                                        <div class="flex-1 min-w-0"><div class="text-sm font-bold truncate text-slate-700">{{ item.name }}</div><div class="text-xs text-red-500">Sisa: {{ item.stock }} Unit</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </transition>

                <!-- 2. KASIR (POS) -->
                <transition name="fade">
                    <div v-show="activeTab === 'pos'" class="h-full flex flex-col lg:flex-row gap-4 relative">
                        <div class="flex-1 flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="p-3 md:p-4 border-b border-slate-100 bg-slate-50 flex gap-2">
                                <div class="relative flex-1 group">
                                    <i class="fas fa-barcode absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                    <input v-model="searchQuery" @keyup="handleKeyup" ref="searchInput" id="posInput" type="text" placeholder="Cari / Scan..." class="w-full pl-9 pr-10 py-2.5 md:py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all shadow-sm text-sm md:text-lg font-medium">
                                    <button @click="openScanner('pos')" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-slate-400 hover:text-indigo-600 transition-colors"><i class="fas fa-camera text-lg"></i></button>
                                </div>
                            </div>
                            <div class="px-3 md:px-4 py-2 flex gap-2 overflow-x-auto custom-scroll border-b border-slate-100 bg-slate-50/50">
                                <button v-for="cat in categories" :key="cat" @click="activeCategory = cat" :class="['px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-all', activeCategory === cat ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-600 hover:bg-slate-100 border border-slate-200']">{{ cat }}</button>
                            </div>
                            <div class="flex-1 overflow-y-auto custom-scroll p-3 md:p-4 bg-slate-50 pb-24 lg:pb-4">
                                <div v-if="filteredProducts.length === 0" class="h-full flex flex-col items-center justify-center text-slate-400"><i class="fas fa-box-open text-4xl mb-2"></i><p>Tidak ada produk</p></div>
                                <div class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-2 md:gap-3">
                                    <div v-for="p in filteredProducts" :key="p.id" @click="addToCart(p)" class="bg-white p-2 md:p-3 rounded-xl border border-slate-200 shadow-sm hover:shadow-md cursor-pointer transition-all flex flex-col group relative overflow-hidden h-full active:scale-95 touch-manipulation">
                                        <div v-if="p.stock <= 5" class="absolute top-2 right-2 z-10 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">Sisa {{ p.stock }}</div>
                                        <div class="h-20 md:h-24 bg-indigo-50 rounded-lg mb-2 flex items-center justify-center text-indigo-300">
                                            <i v-if="p.category.includes('Smartphone')" class="fas fa-mobile-alt text-2xl md:text-3xl"></i>
                                            <i v-else-if="p.category.includes('Aksesoris')" class="fas fa-headphones text-2xl md:text-3xl"></i>
                                            <i v-else-if="p.category.includes('Pulsa')" class="fas fa-sim-card text-2xl md:text-3xl"></i>
                                            <i v-else-if="p.category.includes('Service')" class="fas fa-tools text-2xl md:text-3xl"></i>
                                            <i v-else class="fas fa-cube text-2xl md:text-3xl"></i>
                                        </div>
                                        <h3 class="font-bold text-xs md:text-sm text-slate-800 line-clamp-2 mb-1 flex-1 leading-tight">{{ p.name }}</h3>
                                        <div class="text-indigo-600 font-bold text-xs md:text-sm mt-auto">{{ formatRupiah(p.price) }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div v-if="cart.length > 0" @click="showMobileCart = true" class="lg:hidden fixed bottom-4 left-4 right-4 bg-indigo-600 text-white p-4 rounded-xl shadow-2xl z-30 flex justify-between items-center cursor-pointer hover:bg-indigo-700 transition-colors animate-bounce-in">
                            <div class="font-bold flex items-center"><div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3 font-mono">{{ cart.reduce((a, b) => a + b.qty, 0) }}</div><span>Lihat Keranjang</span></div>
                            <div class="font-bold text-lg">{{ formatRupiah(total) }}</div>
                        </div>
                        <div :class="['bg-white shadow-xl border border-slate-200 flex flex-col z-40 transition-all duration-300', showMobileCart ? 'fixed inset-0 m-0 w-full h-full rounded-none' : 'hidden lg:flex w-96 rounded-xl h-full']">
                            <div v-if="showMobileCart" class="lg:hidden p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h3 class="font-bold text-lg">Keranjang Belanja</h3><button @click="showMobileCart = false" class="w-8 h-8 bg-white rounded-full shadow text-slate-500 flex items-center justify-center"><i class="fas fa-times"></i></button></div>
                            <div class="hidden lg:flex p-4 border-b border-slate-100 justify-between items-center bg-slate-50 rounded-t-xl"><div class="font-bold text-slate-700"><i class="fas fa-shopping-cart mr-2"></i>Keranjang</div><button @click="clearCart" v-if="cart.length" class="text-red-500 text-xs hover:underline font-bold">Reset</button></div>
                            <div class="flex-1 overflow-y-auto custom-scroll p-3 space-y-2">
                                <div v-if="!cart.length" class="h-full flex flex-col items-center justify-center text-slate-300"><i class="fas fa-basket-shopping text-4xl mb-2 opacity-50"></i><span class="text-sm">Belum ada item</span></div>
                                <div v-for="(item, i) in cart" :key="i" class="bg-white border border-slate-100 p-2 rounded-lg flex gap-2 items-center shadow-sm">
                                    <div class="flex-1 min-w-0"><div class="font-bold text-sm text-slate-800 truncate">{{ item.name }}</div><div class="text-xs text-slate-500">{{ formatRupiah(item.price) }} x {{ item.qty }}</div></div>
                                    <div class="flex items-center gap-2 bg-slate-100 rounded p-1"><button @click="updateQty(i, -1)" class="w-8 h-8 bg-white rounded shadow-sm text-slate-600 text-sm hover:text-indigo-600 flex items-center justify-center">-</button><span class="w-6 text-center text-sm font-bold">{{ item.qty }}</span><button @click="updateQty(i, 1)" :disabled="item.qty >= item.stock" class="w-8 h-8 bg-white rounded shadow-sm text-slate-600 text-sm hover:text-indigo-600 disabled:opacity-50 flex items-center justify-center">+</button></div>
                                    <div class="font-bold text-sm text-indigo-600 w-20 text-right hidden sm:block">{{ formatRupiah(item.price * item.qty) }}</div>
                                </div>
                            </div>
                            <div class="p-4 border-t border-slate-100 bg-slate-50 lg:rounded-b-xl pb-safe">
                                <div class="flex justify-between text-slate-600 text-sm mb-1"><span>Subtotal</span><span>{{ formatRupiah(subtotal) }}</span></div>
                                <div class="flex justify-between font-bold text-xl text-slate-800 mb-4"><span>Total</span><span class="text-indigo-600">{{ formatRupiah(total) }}</span></div>
                                <div class="grid grid-cols-4 gap-2 mb-2 lg:hidden"><button @click="clearCart" class="col-span-1 py-3 border border-red-200 text-red-600 rounded-xl font-bold text-sm hover:bg-red-50">Reset</button><button @click="openCheckout" :disabled="!cart.length" class="col-span-3 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all disabled:opacity-50 flex justify-center items-center gap-2">Bayar</button></div>
                                <button @click="openCheckout" :disabled="!cart.length" class="hidden lg:flex w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all disabled:opacity-50 justify-center items-center gap-2"><i class="fas fa-wallet"></i> Bayar</button>
                            </div>
                        </div>
                    </div>
                </transition>

                <!-- 3. PRODUK -->
                <transition name="fade">
                    <div v-if="activeTab === 'products'" class="h-full overflow-y-auto custom-scroll pb-20 md:pb-0">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                            <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto flex-1">
                                <div class="relative flex-1 w-full"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i><input v-model="productSearch" type="text" placeholder="Cari Nama / Barcode..." class="w-full pl-9 pr-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white"></div>
                                <div class="relative w-full md:w-40"><i class="fas fa-filter absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i><select v-model="filterCategory" class="w-full pl-8 pr-8 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 appearance-none bg-white text-sm font-medium text-slate-600 cursor-pointer"><option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option></select><i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i></div>
                            </div>
                            <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0 no-scrollbar">
                                <button @click="downloadTemplate" class="bg-emerald-600 text-white px-3 py-2 rounded-lg font-bold shadow hover:bg-emerald-700 text-xs md:text-sm flex items-center gap-2 whitespace-nowrap"><i class="fas fa-file-download"></i> Template</button>
                                <button @click="$refs.fileInput.click()" class="bg-blue-600 text-white px-3 py-2 rounded-lg font-bold shadow hover:bg-blue-700 text-xs md:text-sm flex items-center gap-2 whitespace-nowrap"><i class="fas fa-file-import"></i> Import</button>
                                <input type="file" ref="fileInput" @change="handleFileUpload" accept=".xlsx, .xls" class="hidden">
                                <button @click="openProductModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-indigo-700 flex items-center gap-2 whitespace-nowrap text-xs md:text-sm"><i class="fas fa-plus"></i> Baru</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200"><tr><th class="p-4">Kode / Barcode</th><th class="p-4">Nama Produk</th><th class="p-4">Kategori</th><th class="p-4 text-right">Harga</th><th class="p-4 text-center">Stok</th><th class="p-4 text-center">Aksi</th></tr></thead><tbody class="divide-y divide-slate-100"><tr v-if="manageProducts.length === 0"><td colspan="6" class="p-8 text-center text-slate-400">Produk tidak ditemukan</td></tr><tr v-for="p in manageProducts" :key="p.id" class="hover:bg-slate-50"><td class="p-4 font-mono text-slate-500">{{ p.id }}</td><td class="p-4 font-bold text-slate-700">{{ p.name }}</td><td class="p-4"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs">{{ p.category }}</span></td><td class="p-4 text-right">{{ formatRupiah(p.price) }}</td><td class="p-4 text-center"><span :class="['px-2 py-1 rounded-full text-xs font-bold', p.stock <= 5 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600']">{{ p.stock }}</span></td><td class="p-4 text-center"><button @click="openProductModal(p)" class="text-blue-500 hover:text-blue-700 mr-3"><i class="fas fa-edit"></i></button><button @click="deleteProduct(p.id)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button></td></tr></tbody></table></div></div>
                    </div>
                </transition>

                <!-- 4. RIWAYAT -->
                <transition name="fade">
                    <div v-if="activeTab === 'history'" class="h-full overflow-y-auto custom-scroll pb-20 md:pb-0">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"><h2 class="font-bold text-lg">Riwayat Transaksi</h2><button @click="exportExcel" class="w-full md:w-auto bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-green-700 flex items-center justify-center gap-2"><i class="fas fa-file-excel"></i> Download Excel</button></div>
                        <div class="space-y-3">
                            <div v-if="transactions.length === 0" class="text-center text-slate-400 py-10">Belum ada transaksi.</div>
                            <div v-for="t in transactions.slice().reverse()" :key="t.id" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                <div class="flex items-center gap-4 w-full sm:w-auto"><div class="w-10 h-10 md:w-12 md:h-12 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 text-xl shrink-0"><i class="fas fa-receipt"></i></div><div class="min-w-0"><div class="font-bold text-indigo-700 truncate">{{ t.invoice }}</div><div class="text-xs text-slate-500">{{ new Date(t.date).toLocaleString('id-ID') }}</div><div class="text-xs text-slate-500 mt-1">{{ t.items.length }} Items | Kasir: {{ t.cashier || '-' }}</div></div></div>
                                <div class="text-right w-full sm:w-auto flex flex-row sm:flex-col justify-between items-center sm:items-end"><div class="font-bold text-lg text-slate-800">{{ formatRupiah(t.total) }}</div><button @click="printReceipt(t)" class="text-sm text-indigo-600 hover:underline font-medium mt-1"><i class="fas fa-print mr-1"></i> Cetak Ulang</button></div>
                            </div>
                        </div>
                    </div>
                </transition>
                
                <!-- 5. PENGATURAN (Settings) -->
                <transition name="fade">
                    <div v-if="activeTab === 'settings'" class="h-full overflow-y-auto custom-scroll p-0 md:p-4 pb-20 md:pb-0">
                        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 max-w-7xl mx-auto items-start">
                            
                            <!-- PENGATURAN TOKO UTAMA -->
                            <div class="xl:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-8 h-fit">
                                <h2 class="text-xl md:text-2xl font-bold text-slate-800 mb-6 border-b pb-4">Pengaturan Toko</h2>
                                <div class="space-y-6">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div><label class="block text-sm font-bold text-slate-600 mb-1">Nama Toko</label><input v-model="settings.storeName" type="text" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                                        <div><label class="block text-sm font-bold text-slate-600 mb-1">Nama Kasir</label><input v-model="settings.cashierName" type="text" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                                    </div>
                                    <div><label class="block text-sm font-bold text-slate-600 mb-1">Alamat</label><textarea v-model="settings.storeAddress" rows="2" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea></div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div><label class="block text-sm font-bold text-slate-600 mb-1">No HP</label><input v-model="settings.storePhone" type="text" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                                        <div><label class="block text-sm font-bold text-slate-600 mb-1">Sosial Media</label><input v-model="settings.socialMedia" type="text" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                                    </div>
                                    <!-- KEAMANAN -->
                                    <div class="border-t border-slate-100 pt-4 mt-4">
                                        <h3 class="font-bold text-indigo-600 mb-3"><i class="fas fa-shield-alt mr-2"></i>Keamanan Aplikasi</h3>
                                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                            <label class="block text-sm font-bold text-slate-600 mb-1">Ubah PIN Login (Default: 123456)</label>
                                            <div class="flex gap-2">
                                                <input v-model="newPin" type="number" placeholder="PIN Baru (Angka)" class="flex-1 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                                <button @click="changePin" class="bg-slate-800 text-white px-4 py-3 rounded-lg font-bold hover:bg-slate-900 whitespace-nowrap">Ganti PIN</button>
                                            </div>
                                            <p class="text-xs text-slate-500 mt-2">* Gunakan angka saja. Pastikan Anda mengingat PIN baru.</p>
                                        </div>
                                    </div>

                                    <div class="pt-4 border-t border-slate-100">
                                        <button @click="saveSettings" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-700 w-full sm:w-auto shadow-lg shadow-indigo-200"><i class="fas fa-save mr-2"></i> Simpan Pengaturan</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- PANDUAN -->
                            <div class="xl:col-span-1 bg-indigo-50 rounded-xl shadow-sm border border-indigo-100 p-6 h-fit md:sticky md:top-4">
                                <h2 class="text-xl font-bold text-indigo-800 mb-4 flex items-center gap-2"><i class="fas fa-book-open"></i> Panduan Lengkap</h2>
                                <div class="space-y-3 text-sm text-slate-700">
                                     <details class="group bg-white rounded-lg border border-indigo-100 overflow-hidden"><summary class="cursor-pointer p-3 font-bold flex justify-between items-center group-open:bg-indigo-50 transition">1. Manajemen Stok<i class="fas fa-chevron-down text-indigo-400 group-open:rotate-180 transition-transform"></i></summary><div class="p-3 border-t border-indigo-100 bg-white text-xs leading-relaxed">- Gunakan menu <strong>Produk</strong> untuk menambah barang baru.<br>- Gunakan fitur <strong>Import Excel</strong> untuk stok masal.<br>- Stok berkurang otomatis saat transaksi selesai.</div></details>
                                     <details class="group bg-white rounded-lg border border-indigo-100 overflow-hidden"><summary class="cursor-pointer p-3 font-bold flex justify-between items-center group-open:bg-indigo-50 transition">2. Scanner Barcode<i class="fas fa-chevron-down text-indigo-400 group-open:rotate-180 transition-transform"></i></summary><div class="p-3 border-t border-indigo-100 bg-white text-xs leading-relaxed">- Bisa pakai Scanner USB atau Kamera HP/Laptop.<br>- Di menu Kasir: Scan -> Masuk Keranjang.<br>- Di menu Produk: Scan -> Isi kolom Barcode.</div></details>
                                     <details class="group bg-white rounded-lg border border-indigo-100 overflow-hidden"><summary class="cursor-pointer p-3 font-bold flex justify-between items-center group-open:bg-indigo-50 transition">3. Login & Keamanan<i class="fas fa-chevron-down text-indigo-400 group-open:rotate-180 transition-transform"></i></summary><div class="p-3 border-t border-indigo-100 bg-white text-xs leading-relaxed">- Default PIN: <strong>123456</strong><br>- Ganti PIN di menu Pengaturan.<br>- Jika lupa PIN, Anda harus menghapus data browser (Clear Site Data) namun data produk akan hilang.</div></details>
                                </div>
                            </div>
                        </div>
                    </div>
                </transition>
            </div>
        </main>
    </div>

    <!-- MODAL POPUPS (Checkout, Scanner, Produk) -->
    <div v-if="modals.checkout" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm no-print">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-fade-in"><div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h3 class="font-bold text-lg">Pembayaran</h3><button @click="modals.checkout = false" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button></div><div class="p-6"><div class="text-center mb-6"><div class="text-sm text-slate-500 font-bold uppercase">Total Tagihan</div><div class="text-4xl font-extrabold text-indigo-600">{{ formatRupiah(total) }}</div></div><div class="mb-4"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Uang Diterima (Cash)</label><input v-model.number="cashReceived" type="number" class="w-full p-4 text-xl font-bold text-right border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="0"></div><div class="grid grid-cols-3 gap-2 mb-4"><button @click="cashReceived = total" class="py-2 bg-slate-100 rounded-lg text-xs font-bold hover:bg-slate-200 transition">Uang Pas</button><button @click="cashReceived = 50000" class="py-2 bg-slate-100 rounded-lg text-xs font-bold hover:bg-slate-200 transition">50.000</button><button @click="cashReceived = 100000" class="py-2 bg-slate-100 rounded-lg text-xs font-bold hover:bg-slate-200 transition">100.000</button></div><div :class="['p-4 rounded-xl border flex justify-between items-center', change >= 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200']"><span class="font-bold text-sm text-slate-700">Kembalian</span><span :class="['text-xl font-bold', change >= 0 ? 'text-green-700' : 'text-red-500']">{{ formatRupiah(change) }}</span></div></div><div class="p-5 bg-slate-50 border-t border-slate-100"><button @click="processTransaction" :disabled="cashReceived < total" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">Proses & Cetak</button></div></div>
    </div>

    <div v-if="modals.scanner" class="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm no-print">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-fade-in relative"><div class="p-4 bg-slate-900 text-white flex justify-between items-center"><h3 class="font-bold"><i class="fas fa-qrcode mr-2"></i> Scan Barcode</h3><button @click="closeScanner" class="text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button></div><div class="p-0 bg-black relative"><div id="reader" class="w-full h-64 sm:h-80 bg-black"></div><div class="absolute inset-0 pointer-events-none flex items-center justify-center"><div class="w-64 h-32 border-2 border-red-500/80 rounded-lg animate-pulse shadow-[0_0_20px_rgba(239,68,68,0.5)]"></div><div class="absolute text-white/70 text-xs font-bold -mt-40">Paskan barcode di dalam kotak</div></div></div></div>
    </div>

    <div v-if="modals.product" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm no-print">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6"><h3 class="font-bold text-lg mb-4 text-slate-800">{{ isEditing ? 'Edit Produk' : 'Tambah Produk Baru' }}</h3><div class="space-y-3"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Barcode / ID</label><div class="relative"><input v-model="productForm.id" :disabled="isEditing" type="text" class="w-full p-2 pr-10 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Scan/Ketik..."><button @click="openScanner('product')" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-indigo-600 transition-colors" title="Scan Barcode"><i class="fas fa-camera"></i></button></div></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Produk</label><input v-model="productForm.name" type="text" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none"></div><div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Harga</label><input v-model.number="productForm.price" type="number" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Stok</label><input v-model.number="productForm.stock" type="number" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none"></div></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kategori</label><select v-model="productForm.category" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none"><option v-for="cat in categories.filter(c => c !== 'Semua')" :key="cat" :value="cat">{{ cat }}</option></select></div></div><div class="flex gap-2 mt-6 justify-end"><button @click="modals.product = false" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg">Batal</button><button @click="saveProduct" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow hover:bg-indigo-700">Simpan</button></div></div>
    </div>

    <!-- Hidden Receipt -->
    <div id="receipt-area" class="hidden">
        <div :style="{ width: '100%', maxWidth: settings.printerSize, margin: '0 auto', textAlign: 'center', color: '#000', fontFamily: '\'Courier New\', monospace', fontSize: '12px' }">
            <img v-if="settings.storeLogo" :src="settings.storeLogo" style="max-width: 80%; height: auto; margin: 0 auto 5px auto; display: block; filter: grayscale(100%);">
            <div style="font-weight: bold; font-size: 16px; margin-bottom: 2px;">{{ settings.storeName }}</div>
            <div style="font-size: 10px; margin-bottom: 2px;">{{ settings.storeAddress }}</div>
            <div style="font-size: 10px; margin-bottom: 5px;" v-if="settings.storePhone || settings.socialMedia">{{ settings.storePhone }}<br v-if="settings.storePhone">{{ settings.socialMedia }}</div>
            <div style="border-bottom: 1px dashed #000; margin-bottom: 5px;"></div>
            <div style="text-align: left; margin-bottom: 5px;" v-if="printData">No: {{ printData.invoice }}<br>Tgl: {{ new Date(printData.date).toLocaleString('id-ID') }}<br>Kasir: {{ printData.cashier || 'Admin' }}</div>
            <div style="border-bottom: 1px dashed #000; margin-bottom: 5px;"></div>
            <table style="width: 100%; text-align: left;" v-if="printData"><tr v-for="item in printData.items" :key="item.id"><td colspan="2" style="padding-bottom: 4px;">{{ item.name }}<br><div style="display: flex; justify-content: space-between;"><span>{{ item.qty }} x {{ formatRupiah(item.price) }}</span><span>{{ formatRupiah(item.qty * item.price) }}</span></div></td></tr></table>
            <div style="border-bottom: 1px dashed #000; margin: 5px 0;"></div>
            <table style="width: 100%; font-weight: bold;" v-if="printData"><tr><td>TOTAL</td><td style="text-align: right;">{{ formatRupiah(printData.total) }}</td></tr><tr><td>TUNAI</td><td style="text-align: right;">{{ formatRupiah(printData.cashReceived || printData.total) }}</td></tr><tr><td>KEMBALI</td><td style="text-align: right;">{{ formatRupiah(printData.change || 0) }}</td></tr></table>
            <div style="border-bottom: 1px dashed #000; margin: 10px 0;"></div><div style="text-align: center; font-size: 10px;">{{ settings.footerMsg }}</div><br>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, reactive, onMounted, nextTick, watch } = Vue;

    createApp({
        setup() {
            // --- LOGIN STATE ---
            const isLoggedIn = ref(false); // Default false
            const loginPin = ref('');
            const pinInputRef = ref(null);
            
            // Check Session Storage
            if(sessionStorage.getItem('f2pos_session') === 'true') {
                isLoggedIn.value = true;
            }

            // --- APP STATE ---
            const sidebarCollapsed = ref(false);
            const mobileMenuOpen = ref(false);
            const showMobileCart = ref(false);
            const activeTab = ref('dashboard');
            
            const searchQuery = ref('');
            const productSearch = ref('');
            const activeCategory = ref('Semua');
            const filterCategory = ref('Semua');
            const cashReceived = ref(0);
            
            const modals = reactive({ checkout: false, product: false, scanner: false });
            const isEditing = ref(false);
            const productForm = reactive({ id: '', name: '', price: 0, stock: 0, category: 'Smartphone' });
            
            const settings = reactive({
                storeName: 'F2CELL CENTER',
                storeAddress: 'Mall ITC Lt. 3 Blok A No. 12',
                storePhone: '0812-3456-7890',
                socialMedia: '@f2cell_store',
                cashierName: 'Admin',
                footerMsg: 'Barang yang dibeli tidak dapat dikembalikan. Garansi Resmi.',
                printerSize: '58mm',
                storeLogo: ''
            });

            const newPin = ref(''); // State untuk ganti PIN

            const printData = ref(null);
            const categories = ['Semua', 'Smartphone', 'Aksesoris', 'Pulsa & Data', 'Service', 'Sparepart'];
            const products = ref([]);
            const cart = ref([]);
            const transactions = ref([]);
            
            // --- SCANNER VARIABLES ---
            let html5QrcodeScanner = null;
            const scannerTarget = ref('pos');
            const searchInput = ref(null);
            let isProcessing = false; // Lock variable untuk mencegah double scan

            // --- AUTH FUNCTIONS ---
            const handleLogin = () => {
                const savedPin = localStorage.getItem('f2pos_pin') || '123456';
                if(loginPin.value === savedPin) {
                    isLoggedIn.value = true;
                    sessionStorage.setItem('f2pos_session', 'true');
                    loginPin.value = '';
                    Swal.fire({ icon: 'success', title: 'Login Berhasil', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
                } else {
                    Swal.fire({ icon: 'error', title: 'PIN Salah!', text: 'Default PIN: 123456', confirmButtonColor: '#4f46e5' });
                    loginPin.value = '';
                }
            };

            const handleLogout = () => {
                Swal.fire({
                    title: 'Keluar Aplikasi?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    confirmButtonText: 'Ya, Keluar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        isLoggedIn.value = false;
                        sessionStorage.removeItem('f2pos_session');
                        mobileMenuOpen.value = false;
                    }
                });
            };

            const changePin = () => {
                if(!newPin.value || newPin.value.length < 4) {
                    return Swal.fire('Error', 'PIN minimal 4 angka', 'error');
                }
                localStorage.setItem('f2pos_pin', newPin.value);
                newPin.value = '';
                Swal.fire('Sukses', 'PIN Login berhasil diubah', 'success');
            };

            // --- DATA LOADING ---
            const loadData = () => {
                const p = localStorage.getItem('f2pos_phone_prods');
                const t = localStorage.getItem('f2pos_phone_trx');
                const s = localStorage.getItem('f2pos_phone_settings');
                
                if(p) products.value = JSON.parse(p);
                else {
                    // Default Dummy Data if empty
                    products.value = [
                        { id: 'IP13-128', name: 'iPhone 13 128GB (Inter)', price: 9500000, stock: 3, category: 'Smartphone' },
                        { id: 'SAM-A55', name: 'Samsung Galaxy A55 5G 8/256', price: 6499000, stock: 5, category: 'Smartphone' },
                        { id: 'TG-GEN', name: 'Tempered Glass Full Lem', price: 25000, stock: 50, category: 'Aksesoris' },
                        { id: 'V-TS10', name: 'Voucher Telkomsel 10GB', price: 35000, stock: 100, category: 'Pulsa & Data' }
                    ];
                }
                if(t) transactions.value = JSON.parse(t);
                if(s) Object.assign(settings, JSON.parse(s));
            };

            // --- COMMON FUNCTIONS ---
            const saveData = () => {
                localStorage.setItem('f2pos_phone_prods', JSON.stringify(products.value));
                localStorage.setItem('f2pos_phone_trx', JSON.stringify(transactions.value));
                localStorage.setItem('f2pos_phone_settings', JSON.stringify(settings));
            };

            const formatRupiah = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num || 0);
            
            // --- SCANNER OPTIMIZATION ---
            
            // 1. Play Beep Sound
            const playBeep = () => {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.type = "square"; 
                    osc.frequency.setValueAtTime(1200, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(500, ctx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.1);
                } catch(e) { console.warn("Audio context failed", e); }
            };

            const openScanner = (target) => {
                scannerTarget.value = target;
                modals.scanner = true;
                isProcessing = false; // Reset lock

                nextTick(() => {
                    if (location.protocol !== "https:" && location.hostname !== "localhost") {
                        Swal.fire({icon:'error', title:'SSL Error', text:'Gunakan HTTPS untuk akses kamera.'});
                        return;
                    }

                    // Callback
                    const onScanSuccess = (decodedText) => {
                        if (isProcessing) return; // Ignore if busy
                        
                        playBeep();

                        if (scannerTarget.value === 'pos') {
                            isProcessing = true; // Lock
                            const p = products.value.find(x => x.id === decodedText);
                            if(p) { 
                                addToCart(p); 
                                Swal.fire({
                                    icon:'success', title:p.name, text: 'Masuk Keranjang', 
                                    toast:true, position:'top', timer:1500, showConfirmButton:false
                                }); 
                            } else {
                                Swal.fire({icon:'error', title:'Tidak Ditemukan', text:decodedText, toast:true, position:'top', timer:2000});
                            }
                            // Unlock after delay (1.5s) to prevent double scan
                            setTimeout(() => { isProcessing = false; }, 1500);
                        } else {
                            // Product form
                            productForm.id = decodedText;
                            closeScanner();
                            Swal.fire({icon: 'success', title: 'Barcode Terisi', timer: 1000, showConfirmButton: false, toast: true, position: 'top'});
                        }
                    };

                    // Init & Config for Speed
                    if(html5QrcodeScanner) html5QrcodeScanner.clear().catch(console.error);
                    
                    html5QrcodeScanner = new Html5Qrcode("reader");
                    const config = { 
                        fps: 25, // INCREASED SPEED
                        qrbox: { width: 250, height: 150 },
                        aspectRatio: 1.0, 
                        experimentalFeatures: { useBarCodeDetectorIfSupported: true } // TURBO MODE
                    };
                    
                    html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, () => {})
                    .catch(() => {
                        // Fallback to user camera if environment fails
                        html5QrcodeScanner.start({ facingMode: "user" }, config, onScanSuccess, () => {});
                    });
                });
            };

            const closeScanner = () => { if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => { html5QrcodeScanner.clear(); modals.scanner = false; }); else modals.scanner = false; };
            
            // Computed Props
            const currentDate = computed(() => new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }));
            const currentTime = ref(''); setInterval(() => currentTime.value = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}), 1000);
            const pageTitle = computed(() => menuItems.find(m => m.id === activeTab.value)?.label);
            const menuItems = [ { id: 'dashboard', label: 'Dashboard', icon: 'fa-chart-pie' }, { id: 'pos', label: 'Kasir', icon: 'fa-cash-register' }, { id: 'products', label: 'Produk', icon: 'fa-boxes' }, { id: 'history', label: 'Riwayat', icon: 'fa-history' }, { id: 'settings', label: 'Pengaturan', icon: 'fa-cog' } ];
            
            const filteredProducts = computed(() => products.value.filter(p => (p.name.toLowerCase().includes(searchQuery.value.toLowerCase()) || p.id.includes(searchQuery.value)) && (activeCategory.value === 'Semua' || p.category === activeCategory.value)));
            const manageProducts = computed(() => products.value.filter(p => (p.name.toLowerCase().includes(productSearch.value.toLowerCase()) || p.id.includes(productSearch.value)) && (filterCategory.value === 'Semua' || p.category === filterCategory.value)));
            
            const subtotal = computed(() => cart.value.reduce((s, i) => s + (i.price * i.qty), 0));
            const total = computed(() => subtotal.value);
            const change = computed(() => cashReceived.value - total.value);
            
            const dashboardStats = computed(() => [
                { title: 'Omset Hari Ini', value: formatRupiah(transactions.value.filter(t => new Date(t.date).toDateString() === new Date().toDateString()).reduce((a, b) => a + b.total, 0)), icon: 'fa-coins', bg: 'bg-green-100', color: 'text-green-600' },
                { title: 'Transaksi Total', value: transactions.value.length, icon: 'fa-receipt', bg: 'bg-blue-100', color: 'text-blue-600' },
                { title: 'Total Produk', value: products.value.length, icon: 'fa-box', bg: 'bg-indigo-100', color: 'text-indigo-600' },
                { title: 'Stok Menipis', value: products.value.filter(p => p.stock <= 5).length, icon: 'fa-exclamation-circle', bg: 'bg-red-100', color: 'text-red-600' },
            ]);
            const lowStockProducts = computed(() => products.value.filter(p => p.stock <= 5));

            // Logic Helpers
            const handleKeyup = (e) => { if(e.key==='Enter') { const p = products.value.find(x=>x.id===searchQuery.value); if(p) addToCart(p); } };
            const addToCart = (p) => { 
                const ex = cart.value.find(c=>c.id===p.id); 
                if(ex) { if(!p.category.includes('Service') && ex.qty>=p.stock) return Swal.fire({icon:'warning', title:'Stok Habis', toast:true, timer:1000}); ex.qty++; } 
                else { if(!p.category.includes('Service') && p.stock<=0) return Swal.fire({icon:'error', title:'Stok 0', toast:true, timer:1000}); cart.value.push({...p, qty:1}); } 
            };
            const updateQty = (i, v) => { const it=cart.value[i]; const pr=products.value.find(p=>p.id===it.id); const n=it.qty+v; if(n>0 && (pr.category.includes('Service') || n<=pr.stock)) it.qty=n; else if(n<=0) cart.value.splice(i,1); };
            const clearCart = () => { cart.value=[]; showMobileCart.value=false; };
            const openCheckout = () => { cashReceived.value=0; modals.checkout=true; showMobileCart.value=false; };
            const processTransaction = () => {
                const trx = { id:Date.now(), invoice:'INV-'+Math.floor(Math.random()*90000+10000), date:new Date().toISOString(), items:JSON.parse(JSON.stringify(cart.value)), total:total.value, cashReceived:cashReceived.value, change:change.value, cashier:settings.cashierName };
                trx.items.forEach(i=>{ const p=products.value.find(x=>x.id===i.id); if(p && !p.category.includes('Service')) p.stock-=i.qty; });
                transactions.value.push(trx); printData.value=trx; saveData(); modals.checkout=false; cart.value=[];
                Swal.fire({icon:'success', title:'Sukses', timer:1500, showConfirmButton:false}).then(()=>nextTick(()=>window.print()));
            };
            const openProductModal = (p) => { isEditing.value=!!p; Object.assign(productForm, p ? JSON.parse(JSON.stringify(p)) : {id:'', name:'', price:0, stock:0, category:'Smartphone'}); modals.product=true; };
            const saveProduct = () => { 
                if(!productForm.name) return; 
                if(isEditing.value) { const i=products.value.findIndex(p=>p.id===productForm.id); if(i>-1) products.value[i]={...productForm}; }
                else { if(products.value.find(p=>p.id===productForm.id)) return Swal.fire('Error','ID Ada','error'); products.value.push({...productForm}); }
                saveData(); modals.product=false; 
            };
            const deleteProduct = (id) => { if(confirm('Hapus?')) { products.value=products.value.filter(p=>p.id!==id); saveData(); } };
            const saveSettings = () => { saveData(); Swal.fire('Disimpan','','success'); };
            const handleLogoUpload = (e) => { const f=e.target.files[0]; if(f&&f.size<500000) { const r=new FileReader(); r.onload=x=>settings.storeLogo=x.target.result; r.readAsDataURL(f); } };
            const removeLogo = () => settings.storeLogo='';
            const downloadTemplate = () => { const ws=XLSX.utils.json_to_sheet([{id:'A1',name:'Contoh',price:1000,stock:10,category:'Smartphone'}]); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Template"); XLSX.writeFile(wb,"Template.xlsx"); };
            const handleFileUpload = (e) => {
                const f=e.target.files[0]; if(!f) return;
                const r=new FileReader(); r.onload=(ev)=>{
                    const wb=XLSX.read(new Uint8Array(ev.target.result),{type:'array'});
                    const d=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    d.forEach(i=>{
                        const id=i.id||i.ID, n=i.name||i.Nama, pr=i.price||i.Harga, s=i.stock||i.Stok, c=i.category||i.Kategori||'Umum';
                        if(id&&n) { const ex=products.value.findIndex(p=>p.id==id); if(ex>-1) products.value[ex]={...products.value[ex],name:n,price:pr,stock:s,category:c}; else products.value.push({id,name:n,price:pr,stock:s,category:c}); }
                    });
                    saveData(); Swal.fire('Import Sukses','','success');
                }; r.readAsArrayBuffer(f);
            };
            const exportExcel = () => { 
                const d = transactions.value.map(t=>({Inv:t.invoice, Date:new Date(t.date).toLocaleDateString(), Total:t.total, Items:t.items.map(x=>x.name).join(', ')}));
                const ws=XLSX.utils.json_to_sheet(d); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Laporan"); XLSX.writeFile(wb,"Laporan.xlsx");
            };
            const printReceipt = (t) => { printData.value=t; nextTick(()=>window.print()); };
            const initChart = () => {
                const ctx = document.getElementById('salesChart'); if(!ctx) return;
                new Chart(ctx, { type: 'line', data: { labels: transactions.value.slice(-7).map(t => t.invoice), datasets: [{ label: 'Omset', data: transactions.value.slice(-7).map(t => t.total), borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false } });
            };

            onMounted(() => { loadData(); if(activeTab.value==='dashboard') nextTick(initChart); });
            watch(activeTab, (v) => { if(v==='dashboard') nextTick(initChart); });

            return {
                isLoggedIn, loginPin, handleLogin, handleLogout, pinInputRef, newPin, changePin, // Auth
                sidebarCollapsed, mobileMenuOpen, showMobileCart, activeTab, 
                searchQuery, productSearch, activeCategory, filterCategory, cashReceived,
                modals, isEditing, productForm, settings, categories, products, cart, transactions, printData,
                currentDate, currentTime, pageTitle, filteredProducts, manageProducts, 
                subtotal, total, change, dashboardStats, lowStockProducts, menuItems, searchInput,
                formatRupiah, handleKeyup, openScanner, closeScanner, addToCart, updateQty, clearCart, openCheckout, processTransaction, printReceipt,
                openProductModal, saveProduct, deleteProduct, saveSettings, handleLogoUpload, removeLogo,
                downloadTemplate, handleFileUpload, exportExcel
            };
        }
    }).mount('#app');
</script>

</body>
</html>
